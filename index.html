<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fitness Pro - Твой Тренажерный Зал</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Firebase SDK (Compat version) -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000;
            color: #fff;
            margin: 0;
            overflow: hidden;
            user-select: none;
            touch-action: pan-y;
            -webkit-tap-highlight-color: transparent;
        }
        /* Hide scrollbar but keep functionality */
        ::-webkit-scrollbar {
            width: 0px;
            background: transparent;
        }
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number], input[type=text] {
            -moz-appearance: textfield;
        }
        .safe-area-bottom {
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .swipe-item-container {
            position: relative;
            overflow: hidden;
            border-radius: 1rem;
        }
        .swipe-action-bg {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 80px;
            background-color: #ef4444;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 800;
            font-size: 0.65rem;
            text-transform: uppercase;
            z-index: 0;
        }
        .swipe-content {
            position: relative;
            z-index: 10;
            background-color: #000;
            transition: transform 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
            touch-action: pan-y;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, memo, useMemo } = React;

        // --- ICONS ---
        const ICONS = {
            Plus: (s) => `<svg width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>`,
            ChevronLeft: (s) => `<svg width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>`,
            Trophy: (s) => `<svg width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path><path d="M4 22h16"></path><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path></svg>`,
            MoreHorizontal: (s) => `<svg width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg>`,
            Check: (s) => `<svg width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`,
            Flame: (s) => `<svg width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.5 3.5 6.5 1.5 2 2 3 2 4.5a4.5 4.5 0 0 1-9 0Z"></path></svg>`,
            Calendar: (s) => `<svg width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>`,
            Trash: (s) => `<svg width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>`,
            Dumbbell: (s) => `<svg width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="m6.5 6.5 11 11"></path><path d="m21 21-1-1"></path><path d="m3 3 1 1"></path><path d="m18 22 4-4"></path><path d="m2 6 4-4"></path><path d="m3 10 7-7"></path><path d="m14 21 7-7"></path></svg>`,
            History: (s) => `<svg width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v5h5"></path><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"></path><path d="M12 7v5l4 2"></path></svg>`,
        };

        const Icon = ({ name, size = 24, className = "" }) => {
            const svgFunc = ICONS[name];
            if (!svgFunc) return null;
            return <span className={`inline-flex items-center justify-center ${className}`} dangerouslySetInnerHTML={{ __html: svgFunc(size) }} />;
        };

        // --- COMPONENTS ---

        const SwipableItem = ({ children, onDelete, id, bgClass = "bg-[#121212]" }) => {
            const [swipeOffset, setSwipeOffset] = useState(0);
            const startX = useRef(0);
            const isDragging = useRef(false);
            const hasMoved = useRef(false);
            const deleteThreshold = 80;

            const onPointerDown = (e) => {
                startX.current = e.clientX;
                isDragging.current = true;
                hasMoved.current = false;
            };

            const onPointerMove = (e) => {
                if (!isDragging.current) return;
                const currentX = e.clientX;
                const diff = currentX - startX.current;
                
                if (!hasMoved.current && Math.abs(diff) > 10) {
                    hasMoved.current = true;
                    e.currentTarget.setPointerCapture(e.pointerId);
                }

                if (hasMoved.current) {
                    // Only allow swipe left
                    if (diff < 0) setSwipeOffset(Math.max(diff, -100));
                    else if (swipeOffset < 0) setSwipeOffset(Math.min(0, diff - deleteThreshold));
                }
            };

            const onPointerUp = (e) => {
                if (!isDragging.current) return;
                isDragging.current = false;
                
                if (hasMoved.current) {
                    e.currentTarget.releasePointerCapture(e.pointerId);
                    if (swipeOffset < -deleteThreshold / 2) setSwipeOffset(-deleteThreshold);
                    else setSwipeOffset(0);
                }
            };

            return (
                <div className="swipe-item-container mb-2">
                    <div className="swipe-action-bg cursor-pointer" onClick={(e) => { e.stopPropagation(); onDelete(id); }}>
                        <div className="flex flex-col items-center gap-1">
                            <Icon name="Trash" size={18} />
                            <span>Удалить</span>
                        </div>
                    </div>
                    <div 
                        className={`swipe-content rounded-2xl ${bgClass}`}
                        style={{ transform: `translateX(${swipeOffset}px)` }}
                        onPointerDown={onPointerDown}
                        onPointerMove={onPointerMove}
                        onPointerUp={onPointerUp}
                        onPointerCancel={onPointerUp}
                    >
                        {children}
                    </div>
                </div>
            );
        };

        const ListView = ({ exercises, history, onSelectHistory, onSelectLog, onAddExercise, onDeleteExercise, onEditExercise }) => {
            
            const getLastLog = (exId) => {
                if (!history) return null;
                const logs = history.filter(h => h.exerciseId === exId);
                return logs.length > 0 ? logs[0] : null;
            };

            return (
                <div className="flex flex-col h-screen bg-black fade-in">
                    <div className="p-6 pt-8 flex justify-between items-center bg-[#121212] border-b border-gray-900 sticky top-0 z-20">
                        <div>
                            <h1 className="text-2xl font-black tracking-tight uppercase italic text-white">Упражнения</h1>
                            <p className="text-[10px] text-gray-500 font-bold uppercase tracking-wider mt-1">Твой прогресс</p>
                        </div>
                        <button onClick={onAddExercise} className="text-blue-500 active:scale-90 transition-transform bg-blue-500/10 p-2 rounded-full">
                            <Icon name="Plus" size={24} />
                        </button>
                    </div>
                    <div className="flex-1 overflow-y-auto px-4 py-4 space-y-1">
                        {exercises.map(ex => {
                            const lastLog = getLastLog(ex.id);
                            return (
                                <SwipableItem key={ex.id} id={ex.id} onDelete={onDeleteExercise} bgClass="bg-black">
                                    <div className="flex items-center py-3 active:bg-gray-900 transition-colors rounded-xl px-2">
                                        <div onClick={() => onSelectHistory(ex)} className={`w-14 h-14 rounded-2xl flex items-center justify-center mr-4 border border-white/5 hover:scale-105 cursor-pointer transition-all flex-shrink-0 bg-gradient-to-br ${ex.bg || 'from-gray-700 to-gray-900'} shadow-lg`}>
                                            <Icon name={ex.icon || 'Dumbbell'} size={28} />
                                        </div>
                                        <div onClick={() => onSelectLog(ex)} className="flex-1 cursor-pointer py-2">
                                            <div className="font-bold text-[16px] text-gray-100 leading-tight">{ex.name}</div>
                                            {lastLog ? (
                                                <div className="flex items-center gap-1 mt-1">
                                                    <Icon name="History" size={10} className="text-gray-500"/>
                                                    <span className="text-[10px] text-gray-500 font-bold uppercase tracking-wide">{lastLog.dateStr} • {lastLog.sets.length} подх.</span>
                                                </div>
                                            ) : (
                                                <div className="text-[10px] text-gray-600 font-bold uppercase tracking-wide mt-1">Нет записей</div>
                                            )}
                                        </div>
                                        <button 
                                            onClick={(e) => { e.stopPropagation(); onEditExercise(ex); }}
                                            className="p-3 text-gray-700 active:text-blue-500 transition-colors"
                                        >
                                            <Icon name="MoreHorizontal" size={20} />
                                        </button>
                                    </div>
                                </SwipableItem>
                            );
                        })}
                        <div className="h-20"></div>
                    </div>
                </div>
            );
        };

        const ExerciseFormView = ({ onBack, onSave, initialData }) => {
            const [name, setName] = useState(initialData?.name || '');
            const handleSave = () => {
                if (!name.trim()) return;
                onSave({ 
                    id: initialData?.id || ('custom-' + Date.now()), 
                    name: name.trim(), 
                    icon: initialData?.icon || 'Dumbbell',
                    bg: initialData?.bg || 'from-gray-600 to-gray-800'
                });
            };
            return (
                <div className="flex flex-col h-screen bg-black fade-in">
                    <div className="p-4 pt-6 flex items-center bg-[#121212] border-b border-gray-900">
                        <div onClick={onBack} className="p-2 -ml-2 cursor-pointer text-blue-500 active:opacity-50"><Icon name="ChevronLeft" size={28} /></div>
                        <h2 className="flex-1 text-center font-black uppercase italic tracking-tighter mr-8 truncate px-2 text-white text-lg">
                            {initialData ? 'Редактировать' : 'Новое'}
                        </h2>
                    </div>
                    <div className="flex-1 p-6 space-y-6">
                        <div className="space-y-3">
                            <label className="text-[10px] font-black text-gray-500 uppercase tracking-widest px-1">Название упражнения</label>
                            <input 
                                type="text" 
                                placeholder="Например: Жим лежа" 
                                className="w-full bg-[#1A1A1A] border border-gray-800 rounded-2xl p-4 text-white font-bold text-lg focus:border-blue-600 outline-none transition-all placeholder-gray-600" 
                                value={name} 
                                onChange={e => setName(e.target.value)} 
                                autoFocus 
                            />
                        </div>
                    </div>
                    <div className="p-4 safe-area-bottom">
                        <button onClick={handleSave} disabled={!name.trim()} className={`w-full py-4 rounded-2xl font-black uppercase italic transition-all ${name.trim() ? 'bg-blue-600 text-white shadow-xl shadow-blue-600/20 active:scale-95' : 'bg-gray-800 text-gray-500'}`}>
                            {initialData ? 'Сохранить' : 'Создать'}
                        </button>
                    </div>
                </div>
            );
        };

        const DetailView = ({ exercise, history, onBack, onStartLog, onDeleteEntry }) => {
            const exHistory = useMemo(() => history.filter(h => h.exerciseId === exercise?.id), [history, exercise]);
            const stats = useMemo(() => {
                let maxWeight = 0; let max1RM = 0;
                exHistory.forEach(workout => {
                    workout.sets.forEach(set => {
                        const w = parseFloat(set.weight) || 0; const r = parseFloat(set.reps) || 0;
                        if (w > maxWeight) maxWeight = w;
                        const current1RM = r === 1 ? w : w * (1 + r / 30);
                        if (current1RM > max1RM) max1RM = current1RM;
                    });
                });
                return { maxWeight: maxWeight.toFixed(0), max1RM: max1RM.toFixed(0) };
            }, [exHistory]);

            return (
                <div className="flex flex-col h-screen bg-black fade-in">
                    <div className="p-4 pt-6 flex items-center bg-[#121212] border-b border-gray-900 sticky top-0 z-20">
                        <div onClick={onBack} className="p-2 -ml-2 cursor-pointer text-blue-500 active:opacity-50"><Icon name="ChevronLeft" size={28} /></div>
                        <h2 className="flex-1 text-center font-black uppercase italic tracking-tighter mr-8 truncate px-2 text-lg">{exercise?.name}</h2>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-6 pb-28">
                        <div className="grid grid-cols-3 gap-3">
                            <div className="bg-[#1A1A1A] p-3 py-4 rounded-2xl flex flex-col items-center border border-gray-900">
                                <Icon name="Trophy" className="text-yellow-500 mb-2" size={20} />
                                <span className="text-[9px] text-gray-500 uppercase font-black tracking-wider">Максимум</span>
                                <span className="text-xl font-black text-white mt-1">{stats.maxWeight} <span className="text-xs text-gray-500">кг</span></span>
                            </div>
                            <div className="bg-[#1A1A1A] p-3 py-4 rounded-2xl flex flex-col items-center border border-gray-900">
                                <Icon name="Flame" className="text-orange-500 mb-2" size={20} />
                                <span className="text-[9px] text-gray-500 uppercase font-black tracking-wider">Рекорд</span>
                                <span className="text-xl font-black text-white mt-1">{stats.max1RM} <span className="text-xs text-gray-500">кг</span></span>
                            </div>
                            <div className="bg-[#1A1A1A] p-3 py-4 rounded-2xl flex flex-col items-center border border-gray-900">
                                <Icon name="Calendar" className="text-blue-500 mb-2" size={20} />
                                <span className="text-[9px] text-gray-500 uppercase font-black tracking-wider">Всего</span>
                                <span className="text-xl font-black text-white mt-1">{exHistory.length}</span>
                            </div>
                        </div>
                        <div className="space-y-2">
                            <h3 className="text-[10px] font-black text-gray-500 uppercase tracking-[0.2em] px-1 mb-4">История тренировок</h3>
                            {exHistory.length === 0 ? (
                                <div className="text-center py-12 flex flex-col items-center gap-3 opacity-50">
                                    <Icon name="Dumbbell" size={40} className="text-gray-700"/>
                                    <div className="text-gray-500 text-sm font-bold">История пока пуста</div>
                                </div>
                            ) : 
                                exHistory.map((item, idx) => (
                                    <SwipableItem key={item.id || idx} id={item.id} onDelete={onDeleteEntry} bgClass="bg-[#121212]">
                                        <div className="rounded-2xl p-4 border border-gray-900 shadow-sm">
                                            <div className="flex justify-between items-center mb-3">
                                                <span className="font-black text-sm uppercase text-white tracking-wide">{item.dateStr}</span>
                                                <span className="text-[9px] bg-blue-500/10 text-blue-500 px-2 py-1 rounded-md font-black tracking-wider uppercase">Силовая</span>
                                            </div>
                                            <div className="grid grid-cols-2 gap-x-4 gap-y-2">
                                                {item.sets.map((s, i) => (
                                                    <div key={i} className="flex justify-between text-sm bg-black/30 p-2 rounded-lg items-center">
                                                        <span className="text-gray-500 text-xs font-bold">#{i+1}</span>
                                                        <span className="font-black text-gray-200 tracking-tight">{s.weight} кг × {s.reps}</span>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </SwipableItem>
                                ))
                            }
                        </div>
                    </div>
                    <div className="p-4 safe-area-bottom absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black via-black to-transparent pt-10 z-20">
                        <button onClick={onStartLog} className="w-full bg-blue-600 text-white font-black py-4 rounded-2xl shadow-xl shadow-blue-900/30 uppercase italic tracking-tight active:scale-95 transition-transform flex items-center justify-center gap-2">
                            <Icon name="Plus" size={20}/>
                            Новая тренировка
                        </button>
                    </div>
                </div>
            );
        };

        const LogView = ({ exercise, sets, restTime, onBack, onSave, onUpdateSet, onToggleSet, onAddSet }) => (
            <div className="flex flex-col h-screen bg-black fade-in">
                <div className="p-4 pt-6 flex items-center justify-between bg-[#121212] border-b border-gray-900 sticky top-0 z-20">
                    <div onClick={onBack} className="p-2 -ml-2 cursor-pointer text-blue-500 active:opacity-50"><Icon name="ChevronLeft" size={28} /></div>
                    <div className="text-center flex-1 px-2 overflow-hidden">
                        <h2 className="text-[10px] font-black uppercase text-gray-500 tracking-widest truncate">{exercise?.name}</h2>
                        <div className={`text-xl font-black mt-0.5 tabular-nums tracking-tight ${restTime > 0 ? 'text-orange-500' : 'text-green-500'}`}>
                            {restTime > 0 ? (
                                <span className="flex items-center justify-center gap-2">
                                    <Icon name="Flame" size={16}/> 
                                    {Math.floor(restTime/60)}:{(restTime%60).toString().padStart(2, '0')}
                                </span>
                            ) : 'ГОТОВ'}
                        </div>
                    </div>
                    <button onClick={onSave} className="text-blue-500 font-black text-[14px] uppercase tracking-wide bg-blue-500/10 px-3 py-1.5 rounded-lg active:bg-blue-500/20">Готово</button>
                </div>
                <div className="flex-1 overflow-y-auto p-4 pb-20">
                    <div className="grid grid-cols-12 gap-3 text-[9px] font-black text-gray-600 uppercase mb-4 px-1 tracking-widest">
                        <div className="col-span-2 text-center">Сет</div>
                        <div className="col-span-4 text-center">Вес (кг)</div>
                        <div className="col-span-4 text-center">Повт</div>
                        <div className="col-span-2"></div>
                    </div>
                    {sets.map((set, idx) => (
                        <div key={idx} className={`grid grid-cols-12 gap-3 items-center mb-3 transition-all duration-300 ${set.status === 'done' ? 'opacity-40' : ''}`}>
                            <div className="col-span-2 flex justify-center">
                                <div className={`w-8 h-8 flex items-center justify-center rounded-lg text-[12px] font-black ${set.status === 'done' ? 'bg-green-900/30 text-green-500' : 'bg-[#1A1A1A] text-gray-400'}`}>
                                    {idx + 1}
                                </div>
                            </div>
                            <div className="col-span-4">
                                <input type="number" placeholder="0" className="w-full bg-[#1A1A1A] border border-gray-800 rounded-xl p-3 text-center text-lg font-black text-white focus:border-blue-500 focus:bg-[#222] outline-none transition-colors" value={set.weight} onChange={e => onUpdateSet(idx, 'weight', e.target.value)} />
                            </div>
                            <div className="col-span-4">
                                <input type="number" placeholder="0" className="w-full bg-[#1A1A1A] border border-gray-800 rounded-xl p-3 text-center text-lg font-black text-white focus:border-blue-500 focus:bg-[#222] outline-none transition-colors" value={set.reps} onChange={e => onUpdateSet(idx, 'reps', e.target.value)} />
                            </div>
                            <div className="col-span-2 flex justify-center">
                                <button onClick={() => onToggleSet(idx)} className={`w-10 h-10 flex items-center justify-center rounded-xl transition-all active:scale-90 ${set.status === 'done' ? 'bg-green-600 text-white shadow-lg shadow-green-900/40' : 'bg-[#1A1A1A] text-gray-600 hover:bg-[#222]'}`}>
                                    <Icon name="Check" size={20} />
                                </button>
                            </div>
                        </div>
                    ))}
                    <button onClick={onAddSet} className="w-full mt-6 py-4 bg-[#121212] text-gray-500 text-[11px] font-black rounded-2xl border-2 border-dashed border-gray-800 hover:border-gray-700 hover:text-gray-400 transition-colors flex items-center justify-center gap-2 uppercase tracking-widest active:bg-gray-800">
                        <Icon name="Plus" size={14} /> 
                        Добавить подход
                    </button>
                </div>
            </div>
        );

        // --- DATA ---
        
        const INITIAL_EXERCISES = [
            { id: 'ex1', name: 'Жим грудь', icon: 'Dumbbell', bg: 'from-rose-500 to-rose-700' },
            { id: 'ex2', name: 'Подтягивание', icon: 'Dumbbell', bg: 'from-emerald-500 to-emerald-700' },
            { id: 'ex3', name: 'Жим плечи', icon: 'Dumbbell', bg: 'from-purple-500 to-purple-700' },
            { id: 'ex4', name: 'Брусья', icon: 'Dumbbell', bg: 'from-indigo-500 to-indigo-700' },
            { id: 'ex5', name: 'Становая', icon: 'Dumbbell', bg: 'from-amber-700 to-orange-900' },
            { id: 'ex6', name: 'Присед', icon: 'Dumbbell', bg: 'from-blue-500 to-blue-700' },
            { id: 'ex7', name: 'Бицепс', icon: 'Dumbbell', bg: 'from-pink-400 to-pink-600' },
            { id: 'ex8', name: 'Трицепс', icon: 'Dumbbell', bg: 'from-cyan-500 to-cyan-700' }
        ];

        // --- APP ---

        const App = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('list'); // list, history, log, exercise_form
            const [selectedExercise, setSelectedExercise] = useState(null);
            const [editingExercise, setEditingExercise] = useState(null);
            const [history, setHistory] = useState([]);
            const [customExercises, setCustomExercises] = useState([]);
            const [hiddenExerciseIds, setHiddenExerciseIds] = useState([]);
            const [sets, setSets] = useState([{ weight: '', reps: '', status: 'empty' }]);
            const [restTime, setRestTime] = useState(0);
            const timerRef = useRef(null);

            // Merge initial and custom exercises
            const allExercises = useMemo(() => {
                const baseList = INITIAL_EXERCISES.map(initEx => {
                    const custom = customExercises.find(cex => cex.id === initEx.id);
                    return custom || initEx;
                });
                const newExercises = customExercises.filter(cex => !INITIAL_EXERCISES.find(iex => iex.id === cex.id));
                const combined = [...newExercises.reverse(), ...baseList];
                return combined.filter(ex => !hiddenExerciseIds.includes(ex.id));
            }, [customExercises, hiddenExerciseIds]);

            // Auth & Init
            useEffect(() => {
                const init = async () => {
                    try {
                        const config = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
                        if (config && window.firebase) {
                            if (!firebase.apps.length) firebase.initializeApp(config);
                            const auth = firebase.auth();
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await auth.signInWithCustomToken(__initial_auth_token).catch(() => auth.signInAnonymously());
                            else await auth.signInAnonymously();
                            auth.onAuthStateChanged(u => setUser(u || { uid: 'local' }));
                        } else setUser({ uid: 'local' });
                    } catch (e) { setUser({ uid: 'local' }); }
                };
                init();
            }, []);

            // Data Sync
            useEffect(() => {
                if (!user) return;
                
                if (user.uid !== 'local' && window.firebase) {
                    const db = firebase.firestore(); 
                    const aid = typeof __app_id !== 'undefined' ? __app_id : 'fitness-pro-app';
                    
                    const unsubHistory = db.collection(`/artifacts/${aid}/users/${user.uid}/history`)
                        .onSnapshot(s => setHistory(s.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0))));
                    
                    const unsubCustom = db.collection(`/artifacts/${aid}/users/${user.uid}/exercises`)
                        .onSnapshot(s => setCustomExercises(s.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
                        
                    const unsubHidden = db.collection(`/artifacts/${aid}/users/${user.uid}/settings`)
                        .doc('hidden_exercises')
                        .onSnapshot(doc => { if (doc.exists) setHiddenExerciseIds(doc.data().ids || []); });
                        
                    return () => { unsubHistory(); unsubCustom(); unsubHidden(); };
                } else {
                    // Local Storage Fallback
                    try {
                        const h = localStorage.getItem('fitness_history'); if (h) setHistory(JSON.parse(h));
                        const e = localStorage.getItem('fitness_custom_exercises'); if (e) setCustomExercises(JSON.parse(e));
                        const hd = localStorage.getItem('fitness_hidden_exercises'); if (hd) setHiddenExerciseIds(JSON.parse(hd));
                    } catch (e) {}
                }
            }, [user]);

            // Timer
            useEffect(() => {
                if (restTime > 0) timerRef.current = setInterval(() => setRestTime(p => p - 1), 1000);
                else clearInterval(timerRef.current);
                return () => clearInterval(timerRef.current);
            }, [restTime]);

            // Handlers
            const handleSaveWorkout = async () => {
                const completedSets = sets.filter(s => s.status === 'done');
                if (completedSets.length > 0) {
                    const now = new Date();
                    const newEntry = { 
                        exerciseId: selectedExercise.id, 
                        exerciseName: selectedExercise.name, 
                        sets: completedSets, 
                        timestamp: (window.firebase && firebase.firestore) ? firebase.firestore.FieldValue.serverTimestamp() : { seconds: Math.floor(now.getTime()/1000) }, 
                        dateStr: now.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' }), 
                        timeStr: now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }) 
                    };
                    
                    if (user && user.uid !== 'local' && window.firebase) {
                        const db = firebase.firestore(); const aid = typeof __app_id !== 'undefined' ? __app_id : 'fitness-pro-app';
                        await db.collection(`/artifacts/${aid}/users/${user.uid}/history`).add(newEntry);
                    } else { 
                        const updated = [newEntry, ...history]; 
                        setHistory(updated); 
                        try { localStorage.setItem('fitness_history', JSON.stringify(updated)); } catch (e) {} 
                    }
                }
                setView('list'); setRestTime(0);
            };

            const handleSaveExercise = async (newEx) => {
                if (user && user.uid !== 'local' && window.firebase) {
                    const db = firebase.firestore(); const aid = typeof __app_id !== 'undefined' ? __app_id : 'fitness-pro-app';
                    await db.collection(`/artifacts/${aid}/users/${user.uid}/exercises`).doc(newEx.id).set(newEx);
                } else { 
                    const isExisting = customExercises.find(ex => ex.id === newEx.id);
                    let updated;
                    if (isExisting) updated = customExercises.map(ex => ex.id === newEx.id ? newEx : ex);
                    else updated = [...customExercises, newEx];
                    setCustomExercises(updated);
                    try { localStorage.setItem('fitness_custom_exercises', JSON.stringify(updated)); } catch (e) {} 
                }
                setView('list'); setEditingExercise(null);
            };

            const handleDeleteExercise = async (id) => {
                if (id.startsWith('ex')) {
                    // Hide default exercise
                    const newHidden = [...hiddenExerciseIds, id]; setHiddenExerciseIds(newHidden);
                    if (user && user.uid !== 'local' && window.firebase) {
                        const db = firebase.firestore(); const aid = typeof __app_id !== 'undefined' ? __app_id : 'fitness-pro-app';
                        await db.collection(`/artifacts/${aid}/users/${user.uid}/settings`).doc('hidden_exercises').set({ ids: newHidden });
                    } else { try { localStorage.setItem('fitness_hidden_exercises', JSON.stringify(newHidden)); } catch (e) {} }
                    return;
                }
                // Delete custom exercise
                if (user && user.uid !== 'local' && window.firebase) {
                    const db = firebase.firestore(); const aid = typeof __app_id !== 'undefined' ? __app_id : 'fitness-pro-app';
                    await db.collection(`/artifacts/${aid}/users/${user.uid}/exercises`).doc(id).delete();
                } else { const updated = customExercises.filter(ex => ex.id !== id); setCustomExercises(updated); try { localStorage.setItem('fitness_custom_exercises', JSON.stringify(updated)); } catch (e) {} }
            };

            const handleDeleteWorkout = async (entryId) => {
                if (user && user.uid !== 'local' && window.firebase) {
                    const db = firebase.firestore(); const aid = typeof __app_id !== 'undefined' ? __app_id : 'fitness-pro-app';
                    await db.collection(`/artifacts/${aid}/users/${user.uid}/history`).doc(entryId).delete();
                } else { const updated = history.filter(h => h.id !== entryId); setHistory(updated); try { localStorage.setItem('fitness_history', JSON.stringify(updated)); } catch (e) {} }
            };

            if (!user) return <div className="h-full flex items-center justify-center text-gray-500 font-bold animate-pulse">Загрузка...</div>;

            return (
                <div className="max-w-md mx-auto h-screen shadow-2xl overflow-hidden bg-black border-x border-gray-900 relative text-white">
                    {view === 'list' && 
                        <ListView 
                            exercises={allExercises} 
                            history={history}
                            onSelectHistory={(ex) => { setSelectedExercise(ex); setView('history'); }} 
                            onSelectLog={(ex) => { setSelectedExercise(ex); setSets([{ weight: '', reps: '', status: 'empty' }]); setView('log'); }} 
                            onAddExercise={() => { setEditingExercise(null); setView('exercise_form'); }} 
                            onDeleteExercise={handleDeleteExercise} 
                            onEditExercise={(ex) => { setEditingExercise(ex); setView('exercise_form'); }} 
                        />
                    }
                    {view === 'exercise_form' && 
                        <ExerciseFormView 
                            initialData={editingExercise} 
                            onBack={() => setView('list')} 
                            onSave={handleSaveExercise} 
                        />
                    }
                    {view === 'history' && 
                        <DetailView 
                            exercise={selectedExercise} 
                            history={history} 
                            onBack={() => setView('list')} 
                            onStartLog={() => { setSets([{ weight: '', reps: '', status: 'empty' }]); setView('log'); }} 
                            onDeleteEntry={handleDeleteWorkout} 
                        />
                    }
                    {view === 'log' && 
                        <LogView 
                            exercise={selectedExercise} 
                            sets={sets} 
                            restTime={restTime} 
                            onBack={() => setView('list')} 
                            onSave={handleSaveWorkout} 
                            onUpdateSet={(i, f, v) => { const n = [...sets]; n[i][f] = v; setSets(n); }} 
                            onToggleSet={(i) => { const n = [...sets]; const d = n[i].status !== 'done'; n[i].status = d ? 'done' : 'empty'; setSets(n); if (d) setRestTime(180); }} 
                            onAddSet={() => setSets([...sets, { weight: '', reps: '', status: 'empty' }])} 
                        />
                    }
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
